<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Giriş - SOC Konsolu</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page">
    <!-- Simulation Notice -->
    <div class="simulation-badge">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Simülasyon Modu — Eğitim Amaçlı
    </div>

    <div class="login-container">
        <div class="login-card">
            <!-- Logo -->
            <div class="login-header">
                <svg class="login-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <h1>SOC Konsolu</h1>
                <p class="login-subtitle" id="subtitle">Güvenlik Operasyon Merkezi</p>
            </div>

            <!-- Setup Form (First Run) -->
            <form id="setup-form" class="login-form" style="display: none;">
                <div class="form-header">
                    <h2>İlk Kurulum</h2>
                    <p>Yönetici parolası belirleyin. Bu parola tarayıcınıza özgüdür.</p>
                </div>

                <div class="form-group">
                    <label for="setup-password">Yönetici Parolası</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="setup-password" autocomplete="new-password" 
                               placeholder="Güçlü bir parola girin" required>
                        <button type="button" class="toggle-password" data-target="setup-password" aria-label="Parolayı göster">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <div class="password-strength" id="setup-strength">
                        <div class="strength-bar"><div class="strength-fill" id="setup-strength-fill"></div></div>
                        <span class="strength-label" id="setup-strength-label">—</span>
                    </div>
                    <div class="caps-lock-warning" id="setup-caps" style="display: none;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        </svg>
                        Caps Lock açık
                    </div>
                </div>

                <div class="form-group">
                    <label for="setup-confirm">Parolayı Onayla</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="setup-confirm" autocomplete="new-password" 
                               placeholder="Parolayı tekrar girin" required>
                        <button type="button" class="toggle-password" data-target="setup-confirm" aria-label="Parolayı göster">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-info">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Cihaza Bağlı — Parola sadece bu tarayıcıda geçerlidir</span>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    <span>Kurulumu Tamamla</span>
                </button>
            </form>

            <!-- Login Form -->
            <form id="login-form" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="username">Kullanıcı Adı</label>
                    <input type="text" id="username" autocomplete="username" 
                           placeholder="Kullanıcı adınızı girin" required>
                </div>

                <div class="form-group">
                    <label for="password">Parola</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" autocomplete="current-password" 
                               placeholder="Parolanızı girin" required>
                        <button type="button" class="toggle-password" data-target="password" aria-label="Parolayı göster">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <div class="caps-lock-warning" id="login-caps" style="display: none;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        </svg>
                        Caps Lock açık
                    </div>
                </div>

                <div class="form-error" id="login-error" style="display: none;"></div>
                <div class="form-lockout" id="login-lockout" style="display: none;">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span id="lockout-timer">—</span>
                </div>

                <button type="submit" class="btn btn-primary btn-lg" id="login-btn">
                    <span>Giriş Yap</span>
                </button>
            </form>

            <!-- Error Display -->
            <div class="login-error" id="global-error" style="display: none;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <span id="error-message"></span>
            </div>
        </div>

        <!-- Footer -->
        <div class="login-footer">
            <p>Anadolu Finans Holding — Güvenlik Operasyon Merkezi</p>
            <p class="muted">Bu bir simülasyon/eğitim projesidir. Gerçek şirketlerle ilişkisi yoktur.</p>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="security.js"></script>
    <script>
        // Login Page Controller
        const LoginPage = {
            init() {
                this.checkSession();
                this.bindEvents();
                this.showAppropriateForm();
            },

            checkSession() {
                const session = Auth.getSession();
                if (session) {
                    this.redirect();
                }
            },

            showAppropriateForm() {
                if (Auth.isFirstRun()) {
                    document.getElementById('setup-form').style.display = 'block';
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('subtitle').textContent = 'İlk Kurulum';
                } else {
                    document.getElementById('setup-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('subtitle').textContent = 'Güvenlik Operasyon Merkezi';
                }
            },

            bindEvents() {
                // Setup form
                document.getElementById('setup-form').addEventListener('submit', (e) => this.handleSetup(e));
                document.getElementById('setup-password').addEventListener('input', (e) => this.updateStrength(e.target.value));
                document.getElementById('setup-password').addEventListener('keyup', (e) => this.checkCapsLock(e, 'setup-caps'));

                // Login form
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('password').addEventListener('keyup', (e) => this.checkCapsLock(e, 'login-caps'));
                document.getElementById('username').addEventListener('input', () => this.checkLockout());

                // Password toggles
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', () => this.togglePassword(btn));
                });
            },

            togglePassword(btn) {
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                btn.classList.toggle('active', !isPassword);
            },

            checkCapsLock(event, warningId) {
                const warning = document.getElementById(warningId);
                warning.style.display = Security.isCapsLockOn(event) ? 'flex' : 'none';
            },

            updateStrength(password) {
                const strength = Auth.checkPasswordStrength(password);
                const fill = document.getElementById('setup-strength-fill');
                const label = document.getElementById('setup-strength-label');
                
                const widthPercent = (strength.score / 5) * 100;
                fill.style.width = widthPercent + '%';
                
                const colors = ['#dc3545', '#dc3545', '#ffc107', '#ffc107', '#28a745', '#28a745'];
                fill.style.backgroundColor = colors[strength.score];
                
                label.textContent = strength.label;
            },

            checkLockout() {
                const username = document.getElementById('username').value;
                if (!username) return;

                const lockStatus = Auth.isLocked(username);
                const lockoutDiv = document.getElementById('login-lockout');
                
                if (lockStatus.locked) {
                    lockoutDiv.style.display = 'flex';
                    this.startLockoutTimer(lockStatus.remainingMs);
                } else {
                    lockoutDiv.style.display = 'none';
                }
            },

            startLockoutTimer(remainingMs) {
                const timerSpan = document.getElementById('lockout-timer');
                const btn = document.getElementById('login-btn');
                
                const update = () => {
                    const remaining = Math.max(0, remainingMs - (Date.now() - this._lockoutStart));
                    if (remaining <= 0) {
                        document.getElementById('login-lockout').style.display = 'none';
                        btn.disabled = false;
                        return;
                    }
                    
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timerSpan.textContent = `Kilitli: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    btn.disabled = true;
                    requestAnimationFrame(update);
                };
                
                this._lockoutStart = Date.now();
                update();
            },

            async handleSetup(e) {
                e.preventDefault();
                this.clearError();
                
                const password = document.getElementById('setup-password').value;
                const confirm = document.getElementById('setup-confirm').value;
                
                if (password !== confirm) {
                    this.showError('Parolalar eşleşmiyor');
                    return;
                }
                
                try {
                    await Auth.bootstrap(password);
                    this.redirect();
                } catch (err) {
                    this.showError(Security.escapeHtml(err.message));
                }
            },

            async handleLogin(e) {
                e.preventDefault();
                this.clearError();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const btn = document.getElementById('login-btn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Doğrulanıyor...';
                
                try {
                    await Auth.authenticate(username, password);
                    this.redirect();
                } catch (err) {
                    this.showError(Security.escapeHtml(err.message));
                    this.checkLockout();
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>Giriş Yap</span>';
                }
            },

            showError(message) {
                const errorDiv = document.getElementById('global-error');
                const msgSpan = document.getElementById('error-message');
                msgSpan.textContent = message;
                errorDiv.style.display = 'flex';
            },

            clearError() {
                document.getElementById('global-error').style.display = 'none';
            },

            redirect() {
                const params = new URLSearchParams(window.location.search);
                const next = params.get('next') || './index.html';
                // Validate redirect URL
                if (next.startsWith('./') || next.startsWith('/') || next === 'index.html') {
                    window.location.href = next;
                } else {
                    window.location.href = './index.html';
                }
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => LoginPage.init());
    </script>
</body>
</html>
